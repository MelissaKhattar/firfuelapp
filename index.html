<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitFuel Meli</title>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom spinner animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
            border-bottom: 2px solid #4f46e5;
        }
        .grocery-item.checked, .exercise-item.checked {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .exercise-item {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.15s ease-in-out;
        }
        .exercise-item:hover {
            background-color: #f3f4f6;
        }
        .week-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase services
        window.firebase = {
            initializeApp,
            getAuth,
            signInWithCustomToken,
            onAuthStateChanged,
            signInAnonymously,
            getFirestore,
            collection,
            doc,
            setDoc,
            onSnapshot,
            deleteDoc,
            getDoc
        };
    </script>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-4xl w-full">
        <!-- Application Title and Description -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-gray-900 mb-2">FitFuel Meli</h1>
            <p class="text-lg text-gray-600">Enter your fitness goals to get a personalized workout and meal plan.</p>
        </div>
        
        <!-- Setup Page: Profiles and Goals -->
        <div id="setup-container" class="space-y-6">
            <!-- Profile Management and Input Area -->
            <div class="bg-gray-50 p-6 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Manage Profiles</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <div class="flex-1">
                        <label for="profile-name" class="block text-sm font-medium text-gray-700">Profile Name</label>
                        <input type="text" id="profile-name" class="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                    </div>
                    <div class="flex-1">
                        <label for="profile-select" class="block text-sm font-medium text-gray-700">Select Profile</label>
                        <select id="profile-select" class="w-full p-2 border border-gray-300 rounded-lg mt-1 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/50"></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button id="save-profile-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">Save Profile</button>
                    <button id="delete-profile-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Delete Profile</button>
                    <button id="new-profile-btn" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors col-span-2">New Profile</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Fitness Goals Input for Person 1 -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Person 1's Fitness Goals</h2>
                    <textarea id="prompt-input-1" rows="8" class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition-all resize-none shadow-sm" placeholder="e.g., I want to build muscle. I am a 25-year-old male, 180 lbs, no dietary restrictions."></textarea>
                </div>
                <!-- Fitness Goals Input for Person 2 -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Person 2's Fitness Goals</h2>
                    <textarea id="prompt-input-2" rows="8" class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition-all resize-none shadow-sm" placeholder="e.g., I want to lose weight. I am a 30-year-old female, 140 lbs, I am a vegetarian."></textarea>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-center mt-6 gap-4">
                <button id="generate-btn" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 flex items-center justify-center w-full sm:w-auto">
                    <span id="btn-text">Generate Combined Plan</span>
                    <div id="loading-spinner" class="spinner hidden ml-2"></div>
                </button>
                <button id="view-plan-btn" class="hidden bg-gray-400 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:bg-gray-500 transition-colors duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-400/50 flex items-center justify-center w-full sm:w-auto">
                    View Existing Plan
                </button>
            </div>
        </div>

        <!-- Plan View Page -->
        <div id="plan-container" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button id="back-to-setup-btn" class="text-indigo-600 font-semibold hover:text-indigo-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Back to Profiles
                </button>
                <h2 class="text-3xl font-bold text-gray-900">Your Personalized Plan</h2>
                <div></div> <!-- Placeholder to balance flexbox -->
            </div>
            
            <!-- Week Navigator -->
            <div id="week-navigator" class="flex items-center justify-center space-x-4 mb-6">
                <button id="prev-week-btn" class="week-nav-btn p-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <span class="text-lg font-bold text-gray-800 flex items-center">Week <span id="current-week-display">1</span><div id="week-spinner" class="spinner hidden ml-2"></div></span>
                <button id="next-week-btn" class="week-nav-btn p-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors flex items-center" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <!-- Tab buttons for toggling views -->
            <div class="flex space-x-2 mb-4">
                <button id="workout-tab-btn" class="tab-button px-4 py-2 rounded-lg text-gray-600 font-semibold hover:bg-gray-100 transition-colors">üèãÔ∏è Workout Plan</button>
                <button id="meal-tab-btn" class="tab-button px-4 py-2 rounded-lg text-gray-600 font-semibold hover:bg-gray-100 transition-colors">ü•ó Meal Plan</button>
                <button id="grocery-tab-btn" class="tab-button px-4 py-2 rounded-lg text-gray-600 font-semibold hover:bg-gray-100 transition-colors">üõí Grocery List</button>
            </div>

            <!-- Content for each tab -->
            <div id="plan-content" class="bg-gray-50 p-8 rounded-xl border border-gray-200 shadow-inner space-y-8">
                <!-- Combined workout plan section -->
                <div id="workout-plan-section" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div id="workout-plan-person-1" class="space-y-4"></div>
                    <div id="workout-plan-person-2" class="space-y-4"></div>
                </div>
                <!-- Combined meal plan section -->
                <div id="meal-plan-section" class="tab-content hidden"></div>
                <!-- Combined grocery list section -->
                <div id="grocery-plan-section" class="tab-content hidden"></div>
            </div>
        </div>

        <!-- Error Message Box (hidden by default) -->
        <div id="error-box" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-4" role="alert">
            <strong class="font-bold">Error!</strong>
            <span id="error-message" class="block sm:inline ml-2">Something went wrong. Please try again.</span>
        </div>

        <!-- Modal for user details -->
        <div id="user-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Your User ID</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500" id="user-id-display"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-modal-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Ensure firebase is available
        const { initializeApp, getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously, getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, getDoc } = window.firebase;

        // The API key for Gemini is automatically handled by the Canvas environment if left empty.
        const apiKey = '';

        // Firebase config and app ID from the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // State variables
        let userId = null;
        let profiles = [];
        let selectedProfileId = null;
        let currentWeek = 1;
        let currentPlan = null; // Holds the full plan for the current week
        let currentPlanSnapshotUnsubscribe = null;
        let currentActiveTabId = 'workout-plan-section'; // New state variable to track the active tab

        // DOM Element selectors
        const setupContainer = document.getElementById('setup-container');
        const planContainer = document.getElementById('plan-container');
        const promptInput1 = document.getElementById('prompt-input-1');
        const promptInput2 = document.getElementById('prompt-input-2');
        const generateBtn = document.getElementById('generate-btn');
        const viewPlanBtn = document.getElementById('view-plan-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const profileNameInput = document.getElementById('profile-name');
        const profileSelect = document.getElementById('profile-select');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const deleteProfileBtn = document.getElementById('delete-profile-btn');
        const newProfileBtn = document.getElementById('new-profile-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const userDetailsModal = document.getElementById('user-details-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const currentWeekDisplay = document.getElementById('current-week-display');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const backToSetupBtn = document.getElementById('back-to-setup-btn');
        const weekSpinner = document.getElementById('week-spinner');


        // Tab-related DOM elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const workoutPlanSection = document.getElementById('workout-plan-section');
        const workoutPlanSection1 = document.getElementById('workout-plan-person-1');
        const workoutPlanSection2 = document.getElementById('workout-plan-person-2');
        const mealPlanSection = document.getElementById('meal-plan-section');
        const groceryListSection = document.getElementById('grocery-plan-section');


        /**
         * Switches the view between the setup page and the plan page.
         * @param {string} pageName 'setup' or 'plan'.
         */
        const showPage = (pageName) => {
            if (pageName === 'setup') {
                setupContainer.classList.remove('hidden');
                planContainer.classList.add('hidden');
            } else if (pageName === 'plan') {
                setupContainer.classList.add('hidden');
                planContainer.classList.remove('hidden');
            }
        };

        /**
         * Authenticates the user and sets up Firestore listeners.
         */
        const setupAuthAndFirestore = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                showError("Authentication failed. Please check your Firebase setup.");
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `Your user ID is: ${userId}`;
                    userDetailsModal.classList.remove('hidden');

                    const profilesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/profiles`);
                    onSnapshot(profilesCollectionRef, (snapshot) => {
                        profiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderProfiles();
                        if (selectedProfileId) {
                             updateUIBasedOnProfileSelection(selectedProfileId);
                        }
                    }, (error) => {
                        console.error("Error listening to profiles:", error);
                        showError("Failed to load profiles. Please try again.");
                    });
                } else {
                    console.log("User is signed out.");
                    userId = null;
                    profiles = [];
                    renderProfiles();
                    currentPlan = null;
                }
            });
        };

        /**
         * Loads and renders the full plan for a specific week from Firestore.
         * Sets up a real-time listener for the current week's plan.
         * @param {number} weekNumber The week to load.
         */
        const loadAndRenderPlan = (weekNumber) => {
            if (!userId) {
                return;
            }
            if (currentPlanSnapshotUnsubscribe) {
                currentPlanSnapshotUnsubscribe(); // Unsubscribe from the previous week's listener
            }

            currentWeek = weekNumber;
            currentWeekDisplay.textContent = currentWeek;

            const planDocRef = doc(db, `artifacts/${appId}/users/${userId}/fullPlans/week-${currentWeek}`);
            
            // Set up a new listener for the current week's plan
            currentPlanSnapshotUnsubscribe = onSnapshot(planDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        currentPlan = JSON.parse(data.plan);
                        renderWorkoutPlans(currentPlan.workoutPlan1, currentPlan.workoutPlan2);
                        renderMealPlan(currentPlan.mealPlan);
                        renderGroceryList(currentPlan.groceryList);
                    } catch (e) {
                        console.error("Failed to parse plan from Firestore:", e);
                        showError("Failed to load plan. Data format may be invalid.");
                        currentPlan = null;
                    }
                    updateWeekNavigation();
                    showTab(currentActiveTabId); // Show the previously active tab
                } else {
                    currentPlan = null;
                    workoutPlanSection1.innerHTML = '';
                    workoutPlanSection2.innerHTML = '';
                    mealPlanSection.innerHTML = '';
                    groceryListSection.innerHTML = '';
                    updateWeekNavigation();
                }
            }, (error) => {
                console.error("Error listening to plan:", error);
                showError("Failed to load plan. Please try again.");
                currentPlan = null;
                updateWeekNavigation();
            });
        };

        /**
         * Checks if a plan exists for the selected profile and updates the UI accordingly.
         * @param {string} profileId The ID of the selected profile.
         */
        const updateUIBasedOnProfileSelection = async (profileId) => {
            if (!profileId) {
                viewPlanBtn.classList.add('hidden');
                generateBtn.textContent = 'Generate Combined Plan';
                return;
            }
            const planDocRef = doc(db, `artifacts/${appId}/users/${userId}/fullPlans/week-1`);
            const docSnap = await getDoc(planDocRef);

            if (docSnap.exists()) {
                viewPlanBtn.classList.remove('hidden');
                generateBtn.textContent = 'Generate New Plan';
            } else {
                viewPlanBtn.classList.add('hidden');
                generateBtn.textContent = 'Generate Combined Plan';
            }
        };

        /**
         * Updates the state of the week navigation buttons.
         */
        const updateWeekNavigation = () => {
            prevWeekBtn.disabled = currentWeek <= 1;
            // The "next" button is enabled if a plan exists for the current week.
            nextWeekBtn.disabled = !currentPlan;
        };

        /**
         * Renders the list of profiles in the dropdown.
         */
        const renderProfiles = () => {
            profileSelect.innerHTML = '<option value="">-- Select a Profile --</option>';
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.name;
                profileSelect.appendChild(option);
            });
            if (selectedProfileId) {
                profileSelect.value = selectedProfileId;
            }
        };

        /**
         * Handles saving or updating a user profile.
         */
        saveProfileBtn.addEventListener('click', async () => {
            if (!userId) {
                showError("User not authenticated. Please wait a moment.");
                return;
            }
            const profileName = profileNameInput.value.trim();
            const fitnessGoal1 = promptInput1.value.trim();
            const fitnessGoal2 = promptInput2.value.trim();

            if (!profileName) {
                showError("Please enter a profile name.");
                return;
            }

            const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profiles`, selectedProfileId || crypto.randomUUID());

            try {
                // Save both goals as a single JSON string in Firestore
                const goals = { goal1: fitnessGoal1, goal2: fitnessGoal2 };
                await setDoc(profileRef, { name: profileName, goals: JSON.stringify(goals) }, { merge: true });
                showError("Profile saved successfully!", "green");
                selectedProfileId = profileRef.id;
            } catch (error) {
                console.error("Error saving profile:", error);
                showError("Failed to save profile. Please try again.");
            }
        });

        /**
         * Handles deleting a user profile.
         */
        deleteProfileBtn.addEventListener('click', async () => {
            if (!selectedProfileId) {
                showError("Please select a profile to delete.");
                return;
            }

            const modalConfirm = confirm("Are you sure you want to delete this profile?");
            if (modalConfirm) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/profiles`, selectedProfileId));
                    showError("Profile deleted successfully!", "green");
                    selectedProfileId = null;
                    profileNameInput.value = '';
                    promptInput1.value = '';
                    promptInput2.value = '';
                    loadAndRenderPlan(1);
                    updateUIBasedOnProfileSelection(null);
                } catch (error) {
                    console.error("Error deleting profile:", error);
                    showError("Failed to delete profile. Please try again.");
                }
            }
        });

        /**
         * Clears inputs for a new profile.
         */
        newProfileBtn.addEventListener('click', () => {
            profileNameInput.value = '';
            promptInput1.value = '';
            promptInput2.value = '';
            selectedProfileId = null;
            profileSelect.value = '';
            // Reset to week 1 for a new profile
            loadAndRenderPlan(1);
            updateUIBasedOnProfileSelection(null);
        });

        /**
         * Loads a selected profile's data into the input fields.
         */
        profileSelect.addEventListener('change', () => {
            const profileId = profileSelect.value;
            if (profileId) {
                const profile = profiles.find(p => p.id === profileId);
                if (profile) {
                    selectedProfileId = profile.id;
                    profileNameInput.value = profile.name;
                    const goals = JSON.parse(profile.goals);
                    promptInput1.value = goals.goal1;
                    promptInput2.value = goals.goal2;
                    updateUIBasedOnProfileSelection(profileId);
                }
            } else {
                newProfileBtn.click();
            }
        });

        /**
         * Handles the API call to the Gemini model with a structured JSON response.
         * @param {string} prompt1 The prompt for person 1.
         * @param {string} prompt2 The prompt for person 2.
         * @param {object | null} previousPlan The plan from the previous week, for progression.
         * @param {number} weekNumber The number of the week to generate.
         */
        const callGeminiAPI = async (prompt1, prompt2, previousPlan, weekNumber) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let planPrompt = `Generate a workout plan for week ${weekNumber}. The workout plan should be for person 1 with the goal: "${prompt1}" and for person 2 with the goal: "${prompt2}".`;
            
            if (previousPlan) {
                planPrompt += ` The workout plan must be a progression from the previous week's plan, with either increased intensity (more reps/sets) or different, slightly more challenging exercises. The meal plan must be entirely different from the previous week. The previous week's plan was: ${JSON.stringify(previousPlan)}.`;
            } else {
                planPrompt += ` Also, generate a single, unified meal plan for both people where the meal for each day is the same, but the quantities are adjusted for each person's goals. The quantities for each person must be included in the meal's description.`;
            }

            planPrompt += ` Lastly, generate a single, combined grocery list with total quantities for both people. Use European measurements. The response must be a single JSON object.`;

            const chatHistory = [{
                role: "user",
                parts: [{ text: planPrompt }]
            }];

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "workoutPlan1": {
                                "type": "ARRAY",
                                "description": "A weekly workout plan for Person 1.",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "day": { "type": "STRING" },
                                        "exercises": {
                                            "type": "ARRAY",
                                            "items": {
                                                "type": "OBJECT",
                                                "properties": {
                                                    "name": { "type": "STRING" },
                                                    "sets": { "type": "STRING" },
                                                    "reps": { "type": "STRING" }
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            "workoutPlan2": {
                                "type": "ARRAY",
                                "description": "A weekly workout plan for Person 2.",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "day": { "type": "STRING" },
                                        "exercises": {
                                            "type": "ARRAY",
                                            "items": {
                                                "type": "OBJECT",
                                                "properties": {
                                                    "name": { "type": "STRING" },
                                                    "sets": { "type": "STRING" },
                                                    "reps": { "type": "STRING" }
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            "mealPlan": {
                                "type": "ARRAY",
                                "description": "A daily meal plan with meals for both people.",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "day": { "type": "STRING" },
                                        "meals": {
                                            "type": "ARRAY",
                                            "items": {
                                                "type": "OBJECT",
                                                "properties": {
                                                    "name": { "type": "STRING" },
                                                    "description1": { "type": "STRING", "description": "Meal description for Person 1, including quantity." },
                                                    "description2": { "type": "STRING", "description": "Meal description for Person 2, including quantity." }
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            "groceryList": {
                                "type": "ARRAY",
                                "description": "A combined list of all ingredients needed for the meal plan with total quantities.",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "item": { "type": "STRING" },
                                        "quantity": { "type": "STRING" }
                                    }
                                }
                            }
                        }
                    }
                }
            };

            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`HTTP error! status: ${response.status}. Details: ${JSON.stringify(errorData)}`);
                    }
                    
                    const result = await response.json();
                    
                    // IMPROVED ERROR HANDLING: Check if the response structure is valid before parsing.
                    const jsonPart = result?.candidates?.[0]?.content?.parts?.[0];
                    if (!jsonPart || !jsonPart.text || jsonPart.text.trim() === '') {
                        throw new Error('API response format is not as expected or is empty.');
                    }
                    
                    // NEW: Add a try/catch around the JSON.parse for robustness
                    try {
                        return JSON.parse(jsonPart.text);
                    } catch (parseError) {
                        console.error('Failed to parse JSON from API response:', parseError);
                        console.log('Raw API response text:', jsonPart.text);
                        throw new Error('Failed to parse the API response. The format may be invalid.');
                    }

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < 4) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        throw error;
                    }
                }
            }
        };
        
        /**
         * Saves the full plan for a given week to Firestore.
         * @param {object} planData The full plan object to save.
         * @param {number} week The week number.
         */
        const savePlan = async (planData, week) => {
            if (!userId) {
                console.error("User not authenticated. Cannot save plan.");
                showError("User not authenticated. Cannot save plan. Please refresh the page.");
                return;
            }
            const planDocRef = doc(db, `artifacts/${appId}/users/${userId}/fullPlans/week-${week}`);
            try {
                await setDoc(planDocRef, { plan: JSON.stringify(planData) });
            } catch (error) {
                console.error("Failed to save plan:", error);
                showError("Failed to save plan. Please try again.");
            }
        };

        /**
         * Renders the workout plan content for a specific person.
         * @param {object} planData The workout plan array for one person.
         * @param {number} personNumber The person's number (1 or 2).
         * @returns {string} The HTML for the workout plan.
         */
        const renderWorkoutPlan = (planData, personNumber) => {
            let html = `<h3 class="text-xl font-bold text-gray-800 mb-4">Workout Plan for Person ${personNumber}</h3>`;
            html += '<div class="space-y-4">';
            planData.forEach((dayPlan, dayIndex) => {
                html += `<div class="p-6 bg-white rounded-lg shadow-md border border-gray-100">`;
                html += `<h4 class="text-xl font-semibold text-indigo-600 mb-2">${dayPlan.day}</h4>`;
                html += `<ul class="list-none mt-2 space-y-1 text-gray-700">`;
                dayPlan.exercises.forEach((exercise, exerciseIndex) => {
                    const checkedClass = exercise.checked ? 'checked' : '';
                    html += `<li class="exercise-item py-1 px-2 rounded-md hover:bg-gray-100 transition-colors ${checkedClass}" data-person="${personNumber}" data-day-index="${dayIndex}" data-exercise-index="${exerciseIndex}">
                        <span class="font-medium">${exercise.name}:</span> ${exercise.sets} sets, ${exercise.reps} reps
                    </li>`;
                });
                html += `</ul>`;
                html += `</div>`;
            });
            html += '</div>';
            return html;
        };

        const renderWorkoutPlans = (plan1, plan2) => {
            workoutPlanSection1.innerHTML = renderWorkoutPlan(plan1, 1);
            workoutPlanSection2.innerHTML = renderWorkoutPlan(plan2, 2);
        };
        
        // Event listener for clicking on workout plan items
        workoutPlanSection.addEventListener('click', (event) => {
            const exerciseItem = event.target.closest('.exercise-item');
            if (exerciseItem && currentPlan) {
                const person = parseInt(exerciseItem.dataset.person, 10);
                const dayIndex = parseInt(exerciseItem.dataset.day-index, 10);
                const exerciseIndex = parseInt(exerciseItem.dataset.exercise-index, 10);

                if (person === 1 && currentPlan.workoutPlan1[dayIndex] && currentPlan.workoutPlan1[dayIndex].exercises[exerciseIndex]) {
                    currentPlan.workoutPlan1[dayIndex].exercises[exerciseIndex].checked = !currentPlan.workoutPlan1[dayIndex].exercises[exerciseIndex].checked;
                } else if (person === 2 && currentPlan.workoutPlan2[dayIndex] && currentPlan.workoutPlan2[dayIndex].exercises[exerciseIndex]) {
                    currentPlan.workoutPlan2[dayIndex].exercises[exerciseIndex].checked = !currentPlan.workoutPlan2[dayIndex].exercises[exerciseIndex].checked;
                }
                savePlan(currentPlan, currentWeek);
            }
        });


        /**
         * Renders the combined meal plan content.
         * @param {object} planData The full meal plan object.
         * @returns {string} The HTML for the combined meal plan.
         */
        const renderMealPlan = (planData) => {
            let html = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">Combined Meal Plan</h3>
                <div class="space-y-6">
            `;
            planData.forEach(dayPlan => {
                html += `
                    <div class="p-6 bg-white rounded-lg shadow-md border border-gray-100">
                        <h4 class="text-xl font-semibold text-indigo-600 mb-4">${dayPlan.day}</h4>
                        <ul class="list-none space-y-4">
                `;
                dayPlan.meals.forEach(meal => {
                    html += `
                        <li class="border-b border-gray-200 pb-4 last:border-b-0 last:pb-0">
                            <p class="font-bold text-lg text-gray-900">${meal.name}</p>
                            <div class="mt-2 text-gray-700 space-y-1">
                                <p><span class="font-semibold text-indigo-500">Person 1:</span> ${meal.description1}</p>
                                <p><span class="font-semibold text-indigo-500">Person 2:</span> ${meal.description2}</p>
                            </div>
                        </li>
                    `;
                });
                html += `</ul></div>`;
            });
            html += '</div>';
            mealPlanSection.innerHTML = html;
        };
        
        /**
         * Renders the grocery list content as an interactive checklist.
         * @param {Array<Object>} list The grocery list with checked state.
         */
        const renderGroceryList = (list) => {
            let html = `<h3 class="text-xl font-bold text-gray-800 mb-4">Combined Grocery List</h3>`;
            html += '<div class="p-6 bg-white rounded-lg shadow-md border border-gray-100">';
            html += '<ul class="list-none columns-2 text-gray-700">';
            list.forEach((item, index) => {
                const checkedClass = item.checked ? 'checked' : '';
                html += `<li class="grocery-item cursor-pointer py-1 px-2 rounded-md hover:bg-gray-100 transition-colors ${checkedClass}" data-index="${index}">${item.item} - ${item.quantity}</li>`;
            });
            html += '</ul>';
            html += '</div>';
            groceryListSection.innerHTML = html;
        };

        // Event listener for clicking on grocery list items
        groceryListSection.addEventListener('click', (event) => {
            const listItem = event.target.closest('.grocery-item');
            if (listItem && currentPlan) {
                const index = parseInt(listItem.dataset.index, 10);
                if (!isNaN(index) && currentPlan.groceryList[index]) {
                    currentPlan.groceryList[index].checked = !currentPlan.groceryList[index].checked;
                    savePlan(currentPlan, currentWeek);
                }
            }
        });

        /**
         * Shows the selected tab and hides others.
         * @param {string} tabId The ID of the tab to show.
         */
        const showTab = (tabId) => {
            tabContents.forEach(content => content.classList.add('hidden'));
            tabButtons.forEach(button => button.classList.remove('active'));
        
            const tabContentElement = document.getElementById(tabId);
            if (tabContentElement) {
                tabContentElement.classList.remove('hidden');
            } else {
                console.error(`Tab content element with ID "${tabId}" not found.`);
            }

            const baseId = tabId.replace('-plan-section', '');
            const buttonId = `${baseId}-tab-btn`;
            const tabButtonElement = document.getElementById(buttonId);
            if (tabButtonElement) {
                tabButtonElement.classList.add('active');
            } else {
                console.error(`Tab button element with ID "${buttonId}" not found.`);
            }
            // Update the active tab state
            currentActiveTabId = tabId;
        };

        // Event listeners for tab buttons
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.id.replace('-tab-btn', '-plan-section');
                showTab(tabId);
            });
        });

        // Event listener for the main generate button
        generateBtn.addEventListener('click', async () => {
            const userPrompt1 = promptInput1.value.trim();
            const userPrompt2 = promptInput2.value.trim();

            if (!userPrompt1 || !userPrompt2) {
                showError('Please enter fitness goals for both people to generate a combined plan.');
                return;
            }

            setLoading(true);
            hideError();

            try {
                const rawPlanData = await callGeminiAPI(userPrompt1, userPrompt2, null, 1);
                
                if (!rawPlanData) {
                    throw new Error("API call returned no data.");
                }

                // Initialize the checked state for all exercises and grocery items
                const newPlanData = {
                    ...rawPlanData,
                    workoutPlan1: rawPlanData.workoutPlan1.map(day => ({
                        ...day,
                        exercises: day.exercises.map(ex => ({ ...ex, checked: false }))
                    })),
                    workoutPlan2: rawPlanData.workoutPlan2.map(day => ({
                        ...day,
                        exercises: day.exercises.map(ex => ({ ...ex, checked: false }))
                    })),
                    groceryList: rawPlanData.groceryList.map(item => ({ ...item, checked: false }))
                };
                
                await savePlan(newPlanData, 1);
                // Reset the active tab to the default for a new plan
                currentActiveTabId = 'workout-plan-section';
                loadAndRenderPlan(1);
                showPage('plan'); // Switch to plan view after successful generation
            } catch (error) {
                console.error("Failed to generate or parse response:", error);
                showError(`An error occurred: ${error.message}. Please check your prompts and try again.`);
            } finally {
                setLoading(false);
            }
        });

        // New event listener for "View Existing Plan" button
        viewPlanBtn.addEventListener('click', () => {
            if (selectedProfileId) {
                loadAndRenderPlan(1);
                showPage('plan');
            }
        });

        // Event listener for "Previous Week" button
        prevWeekBtn.addEventListener('click', () => {
            if (currentWeek > 1) {
                loadAndRenderPlan(currentWeek - 1);
            }
        });

        // Event listener for "Next Week" button
        nextWeekBtn.addEventListener('click', async () => {
            if (currentPlan) {
                const userPrompt1 = promptInput1.value.trim();
                const userPrompt2 = promptInput2.value.trim();
                const nextWeekNumber = currentWeek + 1;
                
                setWeekLoading(true);

                try {
                    const nextWeekDocRef = doc(db, `artifacts/${appId}/users/${userId}/fullPlans/week-${nextWeekNumber}`);
                    const docSnap = await getDoc(nextWeekDocRef);
                    
                    if (docSnap.exists()) {
                        loadAndRenderPlan(nextWeekNumber);
                    } else {
                        const previousPlan = currentPlan;
                        const rawPlanData = await callGeminiAPI(userPrompt1, userPrompt2, previousPlan, nextWeekNumber);
                        
                        if (!rawPlanData) {
                            throw new Error("API call returned no data for the next week.");
                        }

                        // Initialize the checked state for all exercises and grocery items
                        const newPlanData = {
                            ...rawPlanData,
                            workoutPlan1: rawPlanData.workoutPlan1.map(day => ({
                                ...day,
                                exercises: day.exercises.map(ex => ({ ...ex, checked: false }))
                            })),
                            workoutPlan2: rawPlanData.workoutPlan2.map(day => ({
                                ...day,
                                exercises: day.exercises.map(ex => ({ ...ex, checked: false }))
                            })),
                            groceryList: rawPlanData.groceryList.map(item => ({ ...item, checked: false }))
                        };
                        await savePlan(newPlanData, nextWeekNumber);
                        loadAndRenderPlan(nextWeekNumber);
                    }
                } catch (error) {
                    console.error("Failed to generate next week's plan:", error);
                    showError(`An error occurred while generating the next week's plan: ${error.message}`);
                } finally {
                    setWeekLoading(false);
                }
            }
        });

        // Event listener for "Back to Profiles" button
        backToSetupBtn.addEventListener('click', () => {
            showPage('setup');
        });

        function setLoading(isLoading) {
            if (isLoading) {
                btnText.textContent = 'Generating...';
                loadingSpinner.classList.remove('hidden');
                generateBtn.disabled = true;
                viewPlanBtn.disabled = true;
                prevWeekBtn.disabled = true;
                nextWeekBtn.disabled = true;
                promptInput1.disabled = true;
                promptInput2.disabled = true;
                profileNameInput.disabled = true;
                profileSelect.disabled = true;
                saveProfileBtn.disabled = true;
                deleteProfileBtn.disabled = true;
                newProfileBtn.disabled = true;
                backToSetupBtn.disabled = true;
            } else {
                loadingSpinner.classList.add('hidden');
                generateBtn.disabled = false;
                viewPlanBtn.disabled = false;
                promptInput1.disabled = false;
                promptInput2.disabled = false;
                profileNameInput.disabled = false;
                profileSelect.disabled = false;
                saveProfileBtn.disabled = false;
                deleteProfileBtn.disabled = false;
                newProfileBtn.disabled = false;
                backToSetupBtn.disabled = false;
                updateWeekNavigation();
            }
        }
        
        function setWeekLoading(isLoading) {
            if (isLoading) {
                weekSpinner.classList.remove('hidden');
                prevWeekBtn.disabled = true;
                nextWeekBtn.disabled = true;
            } else {
                weekSpinner.classList.add('hidden');
                updateWeekNavigation();
            }
        }

        function showError(message, color = "red") {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            if (color === "green") {
                errorBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                errorBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
            } else {
                errorBox.classList.remove('bg-green-100', 'border-red-400', 'text-red-700');
                errorBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            }
        }

        function hideError() {
            errorBox.classList.add('hidden');
        }

        closeModalBtn.addEventListener('click', () => {
            userDetailsModal.classList.add('hidden');
        });

        setupAuthAndFirestore();
    </script>
</body>
</html>
