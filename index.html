<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitFuel App</title>
    <!-- Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Inter Font -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <!-- Main App Container -->
    <div id="app" class="flex flex-col flex-1">

        <!-- Header -->
        <header class="sticky top-0 z-40 bg-white shadow-sm">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <h1 class="text-2xl font-bold text-blue-600">FitFuel</h1>
                <nav class="flex items-center gap-4">
                    <button id="nav-meal-planner" class="hidden sm:inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chef-hat mr-2 h-4 w-4"><path d="M17 21a1 1 0 0 0 1 1a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1v-2a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1a1 1 0 0 0 1-1a3 3 0 0 1 3-3a3 3 0 0 1 3 3z"/><path d="M16 11V7a4 4 0 0 0-8 0v4"/><path d="M17 11h2.5L20 10.5M5 11H3l-.5-.5"/><path d="M14 2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-2z"/></svg>
                        Meal Planner
                    </button>
                    <button id="nav-workout-planner" class="hidden sm:inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dumbbell mr-2 h-4 w-4"><path d="m6.5 13.5-1.5 1.5a2.12 2.12 0 0 0 3 3L8 16.5m5-5 5-5a2.12 2.12 0 0 0-3-3l-1.5 1.5m-5 5 5 5m0 0 1.5 1.5a2.12 2.12 0 0 0 3-3L16.5 13.5m-5-5-5-5m0 0a2.12 2.12 0 0 0-3 3L6.5 8.5m5-5-5-5a2.12 2.12 0 0 0-3 3L3.5 6.5m10-1a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-5 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-5 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>
                        Workout Planner
                    </button>
                    <button id="add-profile-btn" class="hidden sm:inline-flex items-center bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user mr-2 h-4 w-4"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Add Profile
                    </button>
                    <button id="manage-profiles-btn" class="hidden sm:inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users mr-2 h-4 w-4"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Profiles
                    </button>
                </nav>
            </div>
            <!-- Mobile Navigation -->
            <div class="sm:hidden flex justify-around bg-white border-t border-gray-200">
                <button id="nav-meal-planner-mobile" class="flex-1 rounded-none py-3 text-gray-500 hover:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chef-hat h-5 w-5 mx-auto"></svg>
                </button>
                <button id="nav-workout-planner-mobile" class="flex-1 rounded-none py-3 text-gray-500 hover:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dumbbell h-5 w-5 mx-auto"></svg>
                </button>
                <button id="nav-profiles-mobile" class="flex-1 rounded-none py-3 text-gray-500 hover:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users h-5 w-5 mx-auto"></svg>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 container mx-auto px-4 py-6">
            <!-- Dynamic content will be injected here -->
        </main>

        <!-- Footer -->
        <footer class="py-4 text-center text-sm text-gray-500 border-t">
            <p>FitFuel &copy; 2024</p>
            <p id="user-id-display">User ID: Loading...</p>
        </footer>

    </div>

    <!-- Alert/Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-[100] space-y-2"></div>

    <!-- Modals -->
    <div id="modal-container">
        <!-- Profile Modal -->
        <div id="profile-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md mx-auto w-full shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="profile-modal-title" class="text-2xl font-bold">Create New Profile</h3>
                    <button onclick="closeModal('profile-modal')" class="text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x h-6 w-6"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <p id="profile-modal-description" class="text-sm text-gray-500 mb-4">Enter your details to get personalized plans.</p>
                <form id="profile-form" class="grid gap-4 py-4">
                    <input type="hidden" id="profile-id">
                    <div class="grid grid-cols-4 items-center gap-4">
                        <label for="name" class="text-right text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="name" class="col-span-3 w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="grid grid-cols-4 items-center gap-4">
                        <label for="age" class="text-right text-sm font-medium text-gray-700">Age</label>
                        <input type="number" id="age" class="col-span-3 w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="grid grid-cols-4 items-center gap-4">
                        <label for="gender" class="text-right text-sm font-medium text-gray-700">Gender</label>
                        <select id="gender" class="col-span-3 w-full px-3 py-2 border rounded-md">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-4 items-center gap-4">
                        <label for="weight" class="text-right text-sm font-medium text-gray-700">Weight (kg)</label>
                        <input type="number" id="weight" class="col-span-3 w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="grid grid-cols-4 items-center gap-4">
                        <label for="height" class="text-right text-sm font-medium text-gray-700">Height (cm)</label>
                        <input type="number" id="height" class="col-span-3 w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="grid grid-cols-4 items-center gap-4">
                        <label for="fitnessGoal" class="text-right text-sm font-medium text-gray-700">Goal</label>
                        <select id="fitnessGoal" class="col-span-3 w-full px-3 py-2 border rounded-md">
                            <option value="weight loss">Weight Loss</option>
                            <option value="muscle gain">Muscle Gain</option>
                            <option value="maintenance">Maintenance</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-4 items-center gap-4">
                        <label for="activityLevel" class="text-right text-sm font-medium text-gray-700">Activity</label>
                        <select id="activityLevel" class="col-span-3 w-full px-3 py-2 border rounded-md">
                            <option value="sedentary">Sedentary</option>
                            <option value="lightly active">Lightly Active</option>
                            <option value="moderately active">Moderately Active</option>
                            <option value="very active">Very Active</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-4 items-center gap-4">
                        <label for="dietaryPreferences" class="text-right text-sm font-medium text-gray-700">Dietary</label>
                        <input type="text" id="dietaryPreferences" placeholder="e.g., Vegetarian, Keto" class="col-span-3 w-full px-3 py-2 border rounded-md">
                    </div>
                    <div class="grid grid-cols-4 items-center gap-4">
                        <label for="allergies" class="text-right text-sm font-medium text-gray-700">Allergies</label>
                        <input type="text" id="allergies" placeholder="e.g., Peanuts, Dairy" class="col-span-3 w-full px-3 py-2 border rounded-md">
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" onclick="closeModal('profile-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">Cancel</button>
                        <button type="submit" id="save-profile-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-sm mx-auto w-full shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold">Are you sure?</h3>
                    <button onclick="closeModal('delete-modal')" class="text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x h-6 w-6"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <p id="delete-modal-description" class="text-sm text-gray-500 mb-4">This action cannot be undone. This will permanently delete the profile and all associated data.</p>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal('delete-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">Cancel</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700">Continue</button>
                </div>
            </div>
        </div>

        <!-- Workout Details Modal -->
        <div id="workout-details-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md mx-auto w-full shadow-xl overflow-y-auto max-h-[90vh]">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="workout-details-modal-title" class="text-2xl font-bold">Workout Details</h3>
                    <button onclick="closeModal('workout-details-modal')" class="text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x h-6 w-6"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <div id="workout-details-modal-content"></div>
                <div class="flex items-center justify-between mt-4 border-t pt-4">
                    <div class="flex items-center gap-2">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer" id="mark-workout-complete-toggle">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                        </label>
                        <span class="text-sm font-medium text-gray-700">Mark as Completed</span>
                    </div>
                    <p id="workout-completion-status" class="text-sm font-medium text-gray-500">Not Completed</p>
                </div>
            </div>
        </div>

        <!-- Group Plan Modal -->
        <div id="group-plan-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md mx-auto w-full shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold">Create Group Plan</h3>
                    <button onclick="closeModal('group-plan-modal')" class="text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x h-6 w-6"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mb-4">Select the profiles to include in the group meal plan.</p>
                <div id="group-profiles-list" class="space-y-2 overflow-y-auto max-h-[300px]"></div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal('group-plan-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">Cancel</button>
                    <button id="generate-group-plan-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Generate Plan</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // IMPORTANT: Your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDgZqwg-G-9OzHl4cr-km1UbasU5dDDvbE",
            authDomain: "fuelfit-meli.firebaseapp.com",
            projectId: "fuelfit-meli",
            storageBucket: "fuelfit-meli.firebasestorage.app",
            messagingSenderId: "1011290290269",
            appId: "1:1011290290269:web:16e8dd81360ee4d57cf5b4"
        };
        
        // IMPORTANT: Insert your Gemini API key here. Get it from https://aistudio.google.com/app/apikey
        const apiKey = "AIzaSyCb-h7DP6e6cbMvH4g9dt5IEL9Ddl5iMH4";
        
        const generateUUID = () => {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        let app, db, auth;
        const initFirebase = () => {
            if (Object.values(firebaseConfig).every(val => val !== "")) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                return true;
            } else {
                console.error("Firebase config is missing. Please add your config to the firebaseConfig object.");
                showToast("Firebase config missing. Please add your config to the code.", 'error');
                return false;
            }
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;

        let userId = null;
        let profiles = [];
        let currentProfile = null;
        let mealPlan = null;
        let workoutPlan = null;
        let currentEditingProfile = null;
        let currentPage = 'home';
        let isLoading = false;
        let activeTabIndex = 'Monday';
        let showShoppingList = false;
        let shoppingList = [];

        const callGeminiApi = async (prompt, responseSchema) => {
            if (!apiKey) {
                throw new Error("Gemini API key is not set. Please add your key to the code.");
            }
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                },
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let response;
            let retries = 0;
            const maxRetries = 5;
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            while (retries < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.status !== 429) break;
                    retries++;
                    await delay(Math.pow(2, retries) * 1000);
                } catch (error) {
                    console.error("Fetch failed:", error);
                    throw new Error("Failed to connect to Gemini API.");
                }
            }
            if (response.status === 403) {
                 throw new Error("Gemini API request failed with a 403 Forbidden error. This often means the API key is invalid or has insufficient permissions.");
            }
            if (!response || !response.ok) {
                throw new Error("API request failed after multiple retries.");
            }

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);
            } else {
                throw new Error("Unexpected API response structure.");
            }
        };

        const generateMealPlan = async (selectedProfileIds = []) => {
            if (selectedProfileIds.length === 0) {
                showToast("Please select at least one profile.", 'error');
                return;
            }
            isLoading = true;
            updateLoadingState('meal-plan');
            const generatingMessage = "Generating plan, one moment please...";
            showToast(generatingMessage, 'success');
            
            try {
                const selectedProfiles = profiles.filter(p => selectedProfileIds.includes(p.id));
                let prompt;

                if (selectedProfiles.length > 1) {
                    const groupInfo = selectedProfiles.map(p => `Name: ${p.name}, Age: ${p.age}, Gender: ${p.gender}, Weight: ${p.weight}kg, Height: ${p.height}cm, Goal: ${p.fitnessGoal}, Dietary Preferences: ${p.dietaryPreferences}, Allergies: ${p.allergies}`).join('; ');
                    prompt = `You are a professional nutritionist. Create a 7-day meal plan for a group with the following members, formatted as JSON. The group's profile information: ${groupInfo}. The plan should specify a dish name, total ingredients with measurements, and then individual portion sizes for each person. The plan should be realistic and healthy.`;
                } else {
                    const profile = selectedProfiles[0];
                    prompt = `You are a professional nutritionist. Create a 7-day, 3-meal-per-day meal plan for the following user, formatted as JSON. The user's profile is: Name: ${profile.name}, Age: ${profile.age}, Gender: ${profile.gender}, Weight: ${profile.weight}kg, Height: ${profile.height}cm, BMI: ${profile.bmi}, Goal: ${profile.fitnessGoal}, Dietary Preferences: ${profile.dietaryPreferences}, Allergies: ${profile.allergies}. The plan should specify a dish name, ingredients with measurements, and individual portion sizes. The plan should be realistic and healthy.`;
                }

                const responseSchema = {
                    "type": "OBJECT",
                    "properties": {
                        "weeklyPlan": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "day": { "type": "STRING" },
                                    "meals": {
                                        "type": "ARRAY",
                                        "items": {
                                            "type": "OBJECT",
                                            "properties": {
                                                "name": { "type": "STRING" },
                                                "description": { "type": "STRING" },
                                                "ingredients": { "type": "ARRAY", "items": { "type": "STRING" } },
                                                "portionSizes": { "type": "STRING" }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };

                const newPlanData = await callGeminiApi(prompt, responseSchema);
                mealPlan = { ...newPlanData, id: generateUUID(), createdAt: new Date().toISOString(), profileId: currentProfile.id, groupProfileIds: selectedProfileIds };
                await saveMealPlanToHistory(mealPlan);
                showToast("Meal plan generated successfully!");
            } catch (error) {
                console.error("Error generating meal plan:", error);
                showToast("Failed to generate meal plan. Please try again.", 'error');
            } finally {
                isLoading = false;
                updateLoadingState('meal-plan');
                renderPage();
                closeModal('group-plan-modal');
            }
        };

        const generateWorkoutPlan = async () => {
            if (!currentProfile) {
                showToast("Please select or create a profile first.", 'error');
                return;
            }
            isLoading = true;
            updateLoadingState('workout-plan');
            const generatingMessage = "Generating plan, one moment please...";
            showToast(generatingMessage, 'success');

            try {
                const prompt = `You are a professional personal trainer. Create a 30-day workout plan for the following user, formatted as JSON. The user's profile is: Name: ${currentProfile.name}, Age: ${currentProfile.age}, Gender: ${currentProfile.gender}, Weight: ${currentProfile.weight}kg, Height: ${currentProfile.height}cm, BMI: ${currentProfile.bmi}, Goal: ${currentProfile.fitnessGoal}, Activity Level: ${currentProfile.activityLevel}. The plan should be for a calendar month. Include a variety of exercises, sets, reps, rest times, and a brief description for each day. Only include rest days where no exercises are provided.`;
                
                const responseSchema = {
                    "type": "OBJECT",
                    "properties": {
                        "monthlyPlan": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "day": { "type": "STRING" },
                                    "focus": { "type": "STRING" },
                                    "exercises": {
                                        "type": "ARRAY",
                                        "items": {
                                            "type": "OBJECT",
                                            "properties": {
                                                "name": { "type": "STRING" },
                                                "sets": { "type": "NUMBER" },
                                                "reps": { "type": "STRING" },
                                                "rest": { "type": "STRING" },
                                                "description": { "type": "STRING" }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };

                const newPlanData = await callGeminiApi(prompt, responseSchema);
                workoutPlan = { ...newPlanData, id: generateUUID(), createdAt: new Date().toISOString(), profileId: currentProfile.id, completedWorkouts: [] };
                await saveWorkoutPlanToHistory(workoutPlan);
                showToast("Workout plan generated successfully!");
            } catch (error) {
                console.error("Error generating workout plan:", error);
                showToast("Failed to generate workout plan. Please try again.", 'error');
            } finally {
                isLoading = false;
                updateLoadingState('workout-plan');
                renderPage();
            }
        };

        const renderHomePage = () => {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center h-[calc(100vh-180px)] text-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Welcome to FitFuel!</h2>
                    <p class="text-gray-600 mb-6 max-w-md">
                        To get started, please create your first profile. This will allow the app to generate personalized meal and workout plans for you.
                    </p>
                    <button onclick="openProfileModal()" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus h-4 w-4 mr-2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        Create First Profile
                    </button>
                </div>
            `;
            lucide.createIcons();
        };

        const renderPage = () => {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            mainContent.innerHTML = '';
            
            if (!currentProfile) {
                renderHomePage();
                return;
            }
            mainContent.innerHTML += `
                <div class="flex justify-between items-center mb-6 p-4 bg-white rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-800">
                        Active Profile: <span class="text-blue-600">${currentProfile.name}</span>
                    </h2>
                    <div class="flex items-center gap-2">
                        <button onclick="editProfile('${currentProfile.id}')" class="p-2 rounded-full text-gray-500 hover:text-blue-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit h-5 w-5"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="confirmDeleteProfile('${currentProfile.id}')" class="p-2 rounded-full text-gray-500 hover:text-red-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 h-5 w-5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `;
            switch (currentPage) {
                case 'home': mainContent.innerHTML += getHomePageHTML(); break;
                case 'meal-planner': mainContent.innerHTML += getMealPlannerHTML(); break;
                case 'workout-planner': mainContent.innerHTML += getWorkoutPlannerHTML(); break;
                case 'profiles': mainContent.innerHTML += getProfileManagerHTML(); break;
            }
            lucide.createIcons();
            addEventListeners();
        };

        const getHomePageHTML = () => {
            return `
                <div class="text-center p-8 bg-white rounded-xl shadow-lg">
                    <h2 class="text-4xl font-extrabold text-gray-900 mb-4">Welcome to FitFuel!</h2>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-6">
                        FitFuel is your all-in-one companion for a healthier lifestyle.
                        Create personalized profiles to get tailored workout plans and weekly meal plans that align with your fitness goals.
                        Track your progress, manage your shopping list, and stay motivated.
                    </p>
                    <div class="flex flex-col sm:flex-row justify-center gap-6 mt-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 flex-1">
                            <h3 class="text-2xl font-bold flex items-center justify-center gap-2 text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dumbbell"><path d="m6.5 13.5-1.5 1.5a2.12 2.12 0 0 0 3 3L8 16.5m5-5 5-5a2.12 2.12 0 0 0-3-3l-1.5 1.5m-5 5 5 5m0 0 1.5 1.5a2.12 2.12 0 0 0 3-3L16.5 13.5m-5-5-5-5m0 0a2.12 2.12 0 0 0-3 3L6.5 8.5m5-5-5-5a2.12 2.12 0 0 0-3 3L3.5 6.5m10-1a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-5 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-5 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>
                                Workout
                            </h3>
                            <p class="text-sm text-gray-500 mt-2">Tailored monthly plans to reach your fitness goals.</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 flex-1">
                            <h3 class="text-2xl font-bold flex items-center justify-center gap-2 text-green-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chef-hat"><path d="M17 21a1 1 0 0 0 1 1a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1v-2a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1a1 1 0 0 0 1-1a3 3 0 0 1 3-3a3 3 0 0 1 3 3z"/><path d="M16 11V7a4 4 0 0 0-8 0v4"/><path d="M17 11h2.5L20 10.5M5 11H3l-.5-.5"/><path d="M14 2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-2z"/></svg>
                                Nutrition
                            </h3>
                            <p class="text-sm text-gray-500 mt-2">Personalized weekly meal plans and shopping lists.</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 flex-1">
                            <h3 class="text-2xl font-bold flex items-center justify-center gap-2 text-purple-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                Group Plans
                            </h3>
                            <p class="text-sm text-gray-500 mt-2">Cook for everyone with combined meal and shopping lists.</p>
                        </div>
                    </div>
                </div>
            `;
        };

        const getProfileManagerHTML = () => {
            const profilesHtml = profiles.length > 0 ? profiles.map(profile => `
                <div class="flex items-center justify-between p-4 border rounded-lg mb-2 bg-gray-50">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg">${profile.name}</h4>
                        <p class="text-sm text-gray-500">Goal: ${profile.fitnessGoal} | BMI: ${profile.bmi}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="editProfile('${profile.id}')" class="p-2 rounded-full text-gray-500 hover:text-blue-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit h-4 w-4"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="confirmDeleteProfile('${profile.id}')" class="p-2 rounded-full text-gray-500 hover:text-red-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 h-4 w-4"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                        <button onclick="switchProfile('${profile.id}')" ${currentProfile?.id === profile.id ? 'disabled' : ''} class="px-4 py-2 text-sm font-semibold rounded-md transition-colors ${currentProfile?.id === profile.id ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}">
                            ${currentProfile?.id === profile.id ? 'Active' : 'Switch'}
                        </button>
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-500">No profiles found. Create one to get started.</p>';

            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="mb-4">
                        <h3 class="text-2xl font-bold">Profiles</h3>
                        <p class="text-sm text-gray-500">Create, manage, and switch between multiple user profiles.</p>
                    </div>
                    <div class="space-y-4">
                        <button onclick="openProfileModal()" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus h-4 w-4 mr-2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                            Create New Profile
                        </button>
                        <hr class="h-[1px] bg-gray-200 my-4">
                        <div class="overflow-y-auto h-[400px]">
                            ${profilesHtml}
                        </div>
                    </div>
                </div>
            `;
        };

        const getMealPlannerHTML = () => {
            const tabsHtml = mealPlan ? mealPlan.weeklyPlan.map((day, index) => `
                <button
                    onclick="switchMealDay('${day.day}')"
                    class="flex-1 px-4 py-2 rounded-full text-sm font-medium transition-colors ${activeTabIndex === day.day ? 'bg-blue-600 text-white' : 'text-gray-500 hover:bg-gray-200'}"
                >${day.day}</button>
            `).join('') : '';

            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="mb-4">
                        <h3 class="text-2xl font-bold">Meal Planner</h3>
                        <p class="text-sm text-gray-500">Generate and manage personalized weekly meal plans.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <button id="open-group-plan-modal-btn" class="flex-1 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center">
                            <span id="meal-plan-loading-icon" class="hidden animate-spin h-5 w-5 text-white mr-3">
                                <svg class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" viewBox="0 0 24 24"></svg>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users mr-2 h-4 w-4" id="meal-plan-icon"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Generate Group Plan
                        </button>
                        <button id="view-shopping-list-btn" class="flex-1 px-4 py-2 text-gray-800 font-semibold rounded-md hover:bg-gray-200 transition-colors border bg-white flex items-center justify-center">
                            <span id="shopping-list-icon" class="lucide lucide-list-todo h-4 w-4 mr-2"></span>
                            View Shopping List
                        </button>
                    </div>

                    <div id="meal-plan-content" class="${showShoppingList ? 'hidden' : ''}">
                        ${mealPlan ? `
                            <div class="mt-6">
                                <h3 class="text-lg font-semibold mb-2">Current Meal Plan</h3>
                                <div class="w-full whitespace-nowrap rounded-md border overflow-x-auto bg-gray-100 p-1">
                                    <div class="flex justify-start" id="meal-planner-tabs">
                                        ${tabsHtml}
                                    </div>
                                </div>
                                <div class="mt-2" id="meal-day-content">
                                    ${getMealDayContentHTML()}
                                </div>
                            </div>
                        ` : `<p class="text-center text-gray-500">Generate a meal plan to see it here.</p>`}
                    </div>

                    <div id="shopping-list-content" class="${showShoppingList ? '' : 'hidden'} mt-6">
                        <!-- Shopping list content will be dynamically injected here -->
                    </div>
                </div>
            `;
        };

        const getMealDayContentHTML = () => {
            if (!mealPlan || !mealPlan.weeklyPlan) {
                return '';
            }
            const day = mealPlan.weeklyPlan.find(d => d.day === activeTabIndex);
            if (!day) return '';
            return day.meals.map(meal => `
                <div class="flex items-start gap-4 p-4 border rounded-lg bg-gray-50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chef-hat h-5 w-5 text-blue-600 mt-1"><path d="M17 21a1 1 0 0 0 1 1a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1v-2a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1a1 1 0 0 0 1-1a3 3 0 0 1 3-3a3 3 0 0 1 3 3z"/><path d="M16 11V7a4 4 0 0 0-8 0v4"/><path d="M17 11h2.5L20 10.5M5 11H3l-.5-.5"/><path d="M14 2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-2z"/></svg>
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg">${meal.name}</h4>
                        <p class="text-gray-600">${meal.description}</p>
                        <p class="text-sm text-gray-500">Portion: ${meal.portionSizes}</p>
                        <ul class="text-sm text-gray-500 space-y-1 mt-2">
                            ${(meal.ingredients || []).map(ingredient => `<li>- ${ingredient}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `).join('');
        };

        const getShoppingListHTML = (list) => {
            if (!list || list.length === 0) {
                return `<p class="text-center text-gray-500">Your shopping list is empty. Generate a meal plan to create one.</p>`;
            }
            const listItemsHtml = list.map(item => `
                <div class="flex items-center gap-4 py-2 border-b last:border-b-0">
                    <input type="checkbox" id="item-${item.name}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${item.purchased ? 'checked' : ''} onchange="toggleShoppingItem('${item.name}')">
                    <label for="item-${item.name}" class="flex-1 text-base ${item.purchased ? 'line-through text-gray-400' : ''}">
                        <span class="font-medium">${item.name}</span>
                        <span class="ml-2 text-gray-500">${item.quantity}</span>
                    </label>
                </div>
            `).join('');

            return `
                <div>
                    <h3 class="text-xl font-bold mb-4">Shopping List</h3>
                    <div class="flex gap-2 mb-4">
                        <button onclick="downloadShoppingList()" class="flex-1 px-4 py-2 text-gray-800 font-semibold rounded-md hover:bg-gray-200 transition-colors border bg-white flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download h-4 w-4 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            Download
                        </button>
                        <button onclick="shareShoppingList()" class="flex-1 px-4 py-2 text-gray-800 font-semibold rounded-md hover:bg-gray-200 transition-colors border bg-white flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share-2 h-4 w-4 mr-2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>
                            Share
                        </button>
                    </div>
                    <div class="overflow-y-auto h-[400px] rounded-md border p-4">
                        ${listItemsHtml}
                    </div>
                </div>
            `;
        }

        const getWorkoutPlannerHTML = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            let calendarHtml = '<div class="grid grid-cols-7 gap-1 text-center font-bold text-gray-500 text-sm">';
            const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            weekDays.forEach(day => calendarHtml += `<span>${day}</span>`);
            calendarHtml += '</div><div class="grid grid-cols-7 gap-1 mt-2">';
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarHtml += `<div class="p-2 text-center text-gray-300"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayIndex = day - 1;
                const workoutForDay = workoutPlan?.monthlyPlan[dayIndex];
                const isCompleted = workoutPlan?.completedWorkouts?.includes(dayIndex);
                const isCurrentDay = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                
                const dayClass = `p-2 rounded-lg transition-colors cursor-pointer ${isCurrentDay ? 'bg-blue-600 text-white' : 'hover:bg-gray-200'}`;
                const workoutClass = workoutForDay?.exercises?.length > 0 ? 'bg-green-500 text-white font-bold' : 'bg-gray-200 text-gray-500';
                const completedClass = isCompleted ? 'border-2 border-green-500' : '';
                
                calendarHtml += `
                    <div class="${dayClass} ${workoutForDay ? workoutClass : ''} ${completedClass} flex flex-col items-center" onclick="showWorkoutDetailsForDay(${dayIndex})">
                        <span>${day}</span>
                        ${workoutForDay && workoutForDay.exercises.length > 0 ? `<span class="text-xs mt-1 truncate">${workoutForDay.focus}</span>` : ''}
                    </div>
                `;
            }
            calendarHtml += '</div>';

            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="mb-4">
                        <h3 class="text-2xl font-bold">Workout Planner</h3>
                        <p class="text-sm text-gray-500">Generate and track personalized monthly workout plans.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <button id="generate-workout-plan-btn" class="flex-1 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center">
                            <span id="workout-plan-loading-icon" class="hidden animate-spin h-5 w-5 text-white mr-3">
                                <svg class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" viewBox="0 0 24 24"></svg>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dumbbell h-4 w-4 mr-2" id="workout-plan-icon"><path d="m6.5 13.5-1.5 1.5a2.12 2.12 0 0 0 3 3L8 16.5m5-5 5-5a2.12 2.12 0 0 0-3-3l-1.5 1.5m-5 5 5 5m0 0 1.5 1.5a2.12 2.12 0 0 0 3-3L16.5 13.5m-5-5-5-5m0 0a2.12 2.12 0 0 0-3 3L6.5 8.5m5-5-5-5a2.12 2.12 0 0 0-3 3L3.5 6.5m10-1a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-5 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-5 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>
                            Generate Workout Plan
                        </button>
                    </div>

                    ${workoutPlan ? `
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-2">Current Month: ${monthNames[month]} ${year}</h3>
                            ${calendarHtml}
                        </div>
                    ` : `<p class="text-center text-gray-500">Generate a workout plan to see it here.</p>`}
                </div>
            `;
        };

        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';

            toast.className = `p-4 rounded-md text-white shadow-lg flex items-center gap-2 ${bgColor}`;
            toast.innerHTML = `<p>${message}</p>`;

            container.prepend(toast);
            setTimeout(() => toast.remove(), 5000);
        };

        const openModal = (id, data = null) => {
            const modal = document.getElementById(id);
            if (modal) modal.classList.remove('hidden');

            if (id === 'profile-modal' && data) {
                document.getElementById('profile-id').value = data.id || '';
                document.getElementById('name').value = data.name || '';
                document.getElementById('age').value = data.age || '';
                document.getElementById('gender').value = data.gender || 'male';
                document.getElementById('weight').value = data.weight || '';
                document.getElementById('height').value = data.height || '';
                document.getElementById('dietaryPreferences').value = data.dietaryPreferences || '';
                document.getElementById('allergies').value = data.allergies || '';
                document.getElementById('fitnessGoal').value = data.fitnessGoal || 'maintenance';
                document.getElementById('activityLevel').value = data.activityLevel || 'sedentary';
                document.getElementById('profile-modal-title').textContent = 'Edit Profile';
            } else if (id === 'profile-modal') {
                document.getElementById('profile-form').reset();
                document.getElementById('profile-id').value = '';
                document.getElementById('profile-modal-title').textContent = 'Create New Profile';
            }
        };

        const closeModal = (id) => {
            const modal = document.getElementById(id);
            if (modal) modal.classList.add('hidden');
        };

        const saveProfile = async (e) => {
            e.preventDefault();
            if (!userId) {
                showToast("User not authenticated. Please try again.", 'error');
                return;
            }

            const profileData = {
                id: document.getElementById('profile-id').value || null,
                name: document.getElementById('name').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                weight: parseFloat(document.getElementById('weight').value),
                height: parseFloat(document.getElementById('height').value),
                dietaryPreferences: document.getElementById('dietaryPreferences').value,
                allergies: document.getElementById('allergies').value,
                fitnessGoal: document.getElementById('fitnessGoal').value,
                activityLevel: document.getElementById('activityLevel').value,
            };

            if (!profileData.name || !profileData.age || !profileData.weight || !profileData.height) {
                showToast("Please fill in all required fields.", 'error');
                return;
            }

            profileData.bmi = (profileData.weight / ((profileData.height / 100) ** 2)).toFixed(2);
            isLoading = true;

            try {
                if (profileData.id) {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/profiles`, profileData.id);
                    await setDoc(docRef, profileData);
                    showToast("Profile updated successfully.");
                } else {
                    const profilesRef = collection(db, `artifacts/${appId}/users/${userId}/profiles`);
                    const newDoc = await addDoc(profilesRef, profileData);
                    profileData.id = newDoc.id;
                    profiles.push(profileData);
                    currentProfile = profileData;
                    showToast("New profile created.");
                }
                closeModal('profile-modal');
            } catch (error) {
                console.error("Error saving profile:", error);
                showToast("Failed to save profile. Please try again.", 'error');
            } finally {
                isLoading = false;
            }
        };

        const deleteProfile = async (profileId) => {
            if (!userId || !profileId) return;
            isLoading = true;
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/profiles`, profileId);
                await deleteDoc(docRef);
                showToast("Profile and associated plans deleted.");
                closeModal('delete-modal');
            } catch (error) {
                console.error("Error deleting profile:", error);
                showToast("Failed to delete profile. Please try again.", 'error');
            } finally {
                isLoading = false;
            }
        };

        window.confirmDeleteProfile = (profileId) => {
            currentEditingProfile = profiles.find(p => p.id === profileId);
            if (currentEditingProfile) {
                document.getElementById('delete-modal-description').innerHTML = `This action cannot be undone. This will permanently delete the profile for **${currentEditingProfile.name}** and all associated data.`;
                openModal('delete-modal');
            }
        };
        
        const saveMealPlanToHistory = async (plan) => {
            if (!db || !userId || !plan) return;
            try {
                const plansRef = collection(db, `artifacts/${appId}/users/${userId}/mealPlans`);
                await addDoc(plansRef, plan);
            } catch (error) {
                console.error("Error saving meal plan to history:", error);
            }
        };

        const saveWorkoutPlanToHistory = async (plan) => {
            if (!db || !userId || !plan) return;
            try {
                const plansRef = collection(db, `artifacts/${appId}/users/${userId}/workoutPlans`);
                await addDoc(plansRef, plan);
            } catch (error) {
                console.error("Error saving workout plan to history:", error);
            }
        };

        const updateLoadingState = (planType) => {
            const button = document.getElementById(`generate-${planType}-btn`);
            const icon = document.getElementById(`${planType}-icon`);
            const loadingIcon = document.getElementById(`${planType}-loading-icon`);
            const buttonText = document.getElementById(`${planType}-btn-text`);

            if (isLoading) {
                if (button) button.disabled = true;
                if (icon) icon.classList.add('hidden');
                if (loadingIcon) loadingIcon.classList.remove('hidden');
                if (buttonText) buttonText.textContent = "Generating plan...";
            } else {
                if (button) button.disabled = false;
                if (icon) icon.classList.remove('hidden');
                if (loadingIcon) loadingIcon.classList.add('hidden');
                if (buttonText) buttonText.textContent = `Generate ${planType === 'meal-plan' ? 'Meal Plan' : 'Workout Plan'}`;
            }
        };

        window.toggleShoppingList = () => {
            showShoppingList = !showShoppingList;
            if (showShoppingList) {
                generateAndRenderShoppingList();
            }
            renderPage();
        }

        const generateAndRenderShoppingList = () => {
            const shoppingListContent = document.getElementById('shopping-list-content');
            if (shoppingListContent && mealPlan) {
                const allIngredients = mealPlan.weeklyPlan.flatMap(day => day.meals.flatMap(meal => meal.ingredients || []));
                const shoppingListMap = {};

                allIngredients.forEach(item => {
                    const match = item.match(/^(\d+\.?\d*)\s*(g|kg|ml|l|tbsp|tsp|cup|cups)?\s*(.+)$/i);
                    let quantity = 1;
                    let unit = '';
                    let name = item;
                    if (match) {
                        quantity = parseFloat(match[1]);
                        unit = match[2] || '';
                        name = match[3].trim();
                    }
                    if (shoppingListMap[name]) {
                        // For simplicity, we just add the quantities if units are the same
                        shoppingListMap[name].quantity += quantity;
                    } else {
                        shoppingListMap[name] = { quantity: quantity, unit: unit, purchased: false };
                    }
                });

                shoppingList = Object.entries(shoppingListMap).map(([name, data]) => ({ name, quantity: `${data.quantity} ${data.unit}`, purchased: data.purchased }));
                shoppingListContent.innerHTML = getShoppingListHTML(shoppingList);
                lucide.createIcons();
            } else if (shoppingListContent) {
                shoppingListContent.innerHTML = getShoppingListHTML([]);
            }
        };

        window.toggleShoppingItem = (itemName) => {
             const item = shoppingList.find(i => i.name === itemName);
             if (item) {
                 item.purchased = !item.purchased;
             }
             generateAndRenderShoppingList();
        }
        
        window.downloadShoppingList = () => {
            // Placeholder for PDF generation
            showToast("Download functionality is not implemented yet.", 'error');
        };

        window.shareShoppingList = () => {
            // Placeholder for share functionality
            showToast("Share functionality is not implemented yet.", 'error');
        };

        window.openGroupPlanModal = () => {
            const list = document.getElementById('group-profiles-list');
            if (list) {
                const profilesHtml = profiles.map(p => `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="group-profile-${p.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${p.id}" ${p.id === currentProfile.id ? 'checked' : ''}>
                        <label for="group-profile-${p.id}" class="text-sm font-medium text-gray-700">${p.name}</label>
                    </div>
                `).join('');
                list.innerHTML = profilesHtml;
            }
            openModal('group-plan-modal');
        };

        window.generateGroupPlan = () => {
            const selectedProfileIds = Array.from(document.querySelectorAll('#group-profiles-list input:checked'))
                .map(checkbox => checkbox.dataset.id);
            if (selectedProfileIds.length > 0) {
                generateMealPlan(selectedProfileIds);
            } else {
                showToast("Please select at least one profile.", 'error');
            }
        };

        window.showWorkoutDetailsForDay = (dayIndex) => {
            if (!workoutPlan || !workoutPlan.monthlyPlan[dayIndex]) {
                showToast("No workout plan for this day.", 'error');
                return;
            }

            const dayPlan = workoutPlan.monthlyPlan[dayIndex];
            const modalTitle = document.getElementById('workout-details-modal-title');
            const modalContent = document.getElementById('workout-details-modal-content');
            const completionToggle = document.getElementById('mark-workout-complete-toggle');
            const completionStatus = document.getElementById('workout-completion-status');

            modalTitle.textContent = `${dayPlan.day}: ${dayPlan.focus}`;
            if (dayPlan.exercises.length > 0) {
                modalContent.innerHTML = dayPlan.exercises.map(exercise => `
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-lg mb-1">${exercise.name}</h4>
                        <p class="text-gray-600 mb-2">${exercise.description}</p>
                        <ul class="text-sm text-gray-500 space-y-1">
                            <li>Sets: ${exercise.sets}</li>
                            <li>Reps: ${exercise.reps}</li>
                            <li>Rest: ${exercise.rest}</li>
                        </ul>
                    </div>
                `).join('');
            } else {
                modalContent.innerHTML = `<p class="text-center text-gray-500">Enjoy your rest day!</p>`;
            }

            const isCompleted = workoutPlan.completedWorkouts.includes(dayIndex);
            completionToggle.checked = isCompleted;
            completionStatus.textContent = isCompleted ? 'Completed!' : 'Not Completed';
            completionStatus.className = `text-sm font-medium ${isCompleted ? 'text-green-600' : 'text-gray-500'}`;

            completionToggle.onchange = () => {
                toggleWorkoutCompletion(dayIndex);
            };

            openModal('workout-details-modal');
        };

        window.toggleWorkoutCompletion = (dayIndex) => {
            if (!workoutPlan) return;
            const newCompletedWorkouts = workoutPlan.completedWorkouts.includes(dayIndex)
                ? workoutPlan.completedWorkouts.filter(d => d !== dayIndex)
                : [...workoutPlan.completedWorkouts, dayIndex];
            workoutPlan.completedWorkouts = newCompletedWorkouts;
            
            if (workoutPlan.id) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/workoutPlans`, workoutPlan.id);
                updateDoc(docRef, { completedWorkouts: newCompletedWorkouts });
            }
            
            const isCompleted = newCompletedWorkouts.includes(dayIndex);
            const completionStatus = document.getElementById('workout-completion-status');
            if (completionStatus) {
                completionStatus.textContent = isCompleted ? 'Completed!' : 'Not Completed';
                completionStatus.className = `text-sm font-medium ${isCompleted ? 'text-green-600' : 'text-gray-500'}`;
            }
            
            renderPage();
        };

        const addEventListeners = () => {
            document.querySelectorAll('#nav-meal-planner, #nav-meal-planner-mobile').forEach(btn => btn.onclick = () => { currentPage = 'meal-planner'; renderPage(); });
            document.querySelectorAll('#nav-workout-planner, #nav-workout-planner-mobile').forEach(btn => btn.onclick = () => { currentPage = 'workout-planner'; renderPage(); });
            document.querySelectorAll('#nav-profiles-mobile, #manage-profiles-btn').forEach(btn => btn.onclick = () => { currentPage = 'profiles'; renderPage(); });
            document.querySelectorAll('#add-profile-btn').forEach(btn => btn.onclick = () => openModal('profile-modal'));

            const profileForm = document.getElementById('profile-form');
            if (profileForm) profileForm.onsubmit = saveProfile;

            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            if (confirmDeleteBtn) confirmDeleteBtn.onclick = () => deleteProfile(currentEditingProfile.id);

            const generateMealPlanBtn = document.getElementById('generate-meal-plan-btn');
            if (generateMealPlanBtn) generateMealPlanBtn.onclick = () => generateMealPlan([currentProfile.id]);

            const generateWorkoutPlanBtn = document.getElementById('generate-workout-plan-btn');
            if (generateWorkoutPlanBtn) generateWorkoutPlanBtn.onclick = generateWorkoutPlan;
            
            const openGroupPlanModalBtn = document.getElementById('open-group-plan-modal-btn');
            if (openGroupPlanModalBtn) openGroupPlanModalBtn.onclick = openGroupPlanModal;

            const generateGroupPlanBtn = document.getElementById('generate-group-plan-btn');
            if (generateGroupPlanBtn) generateGroupPlanBtn.onclick = generateGroupPlan;

            const viewShoppingListBtn = document.getElementById('view-shopping-list-btn');
            if (viewShoppingListBtn) viewShoppingListBtn.onclick = toggleShoppingList;
        };
        
        const init = async () => {
            if (!initFirebase()) {
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        showToast("Failed to authenticate. Please check your Firebase setup.", 'error');
                        return;
                    }
                }
                userId = auth.currentUser?.uid || 'anonymous-user';
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                
                onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/profiles`), (snapshot) => {
                    profiles = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    if (!currentProfile && profiles.length > 0) {
                        currentProfile = profiles[0];
                    } else if (currentProfile && !profiles.find(p => p.id === currentProfile.id)) {
                        currentProfile = profiles[0] || null;
                    }
                    renderPage();
                });
                
                onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/mealPlans`), (snapshot) => {
                    const mealPlans = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    if (mealPlans.length > 0) {
                        mealPlan = mealPlans[0];
                        if (currentPage === 'meal-planner') renderPage();
                    }
                });
                
                onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/workoutPlans`), (snapshot) => {
                    const workoutPlans = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    if (workoutPlans.length > 0) {
                        workoutPlan = workoutPlans[0];
                        if (currentPage === 'workout-planner') renderPage();
                    }
                });
            });
        };

        window.openProfileModal = () => openModal('profile-modal');
        window.editProfile = (profileId) => {
            const profile = profiles.find(p => p.id === profileId);
            if (profile) openModal('profile-modal', profile);
        };
        window.switchProfile = (profileId) => {
            currentProfile = profiles.find(p => p.id === profileId);
            if (currentProfile) {
                showToast(`Active profile switched to ${currentProfile.name}.`);
                renderPage();
            }
        };
        window.closeModal = (id) => closeModal(id);

        window.switchMealDay = (day) => {
            activeTabIndex = day;
            const mealPlannerTabs = document.getElementById('meal-planner-tabs');
            if (mealPlannerTabs) {
                 document.querySelectorAll('#meal-planner-tabs button').forEach(btn => {
                     if (btn.textContent.includes(day)) {
                         btn.classList.add('bg-blue-600', 'text-white');
                         btn.classList.remove('text-gray-500', 'hover:bg-gray-200');
                     } else {
                         btn.classList.remove('bg-blue-600', 'text-white');
                         btn.classList.add('text-gray-500', 'hover:bg-gray-200');
                     }
                 });
            }
            const mealDayContent = document.getElementById('meal-day-content');
            if (mealDayContent) {
                mealDayContent.innerHTML = getMealDayContentHTML();
                lucide.createIcons();
            }
        };

        window.switchWorkoutDay = (day) => {
            activeTabIndex = day;
            const workoutPlannerTabs = document.getElementById('workout-planner-tabs');
            if (workoutPlannerTabs) {
                document.querySelectorAll('#workout-planner-tabs button').forEach(btn => {
                    if (btn.textContent.includes(day)) {
                        btn.classList.add('bg-blue-600', 'text-white');
                        btn.classList.remove('text-gray-500', 'hover:bg-gray-200');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('text-gray-500', 'hover:bg-gray-200');
                    }
                });
            }
            renderPage();
        };

        window.showWorkoutDetails = (dayId) => {
            const details = document.getElementById(`workout-details-${dayId}`);
            if (details) details.classList.toggle('hidden');
        };

        document.addEventListener('DOMContentLoaded', () => {
             init();
             lucide.createIcons();
             addEventListeners();
        });
    </script>
</body>
</html>
